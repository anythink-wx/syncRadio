<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>秘密花园</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=520,user-scalable=no,minimal-ui">
    <!--<script src="static/jquery-1.11.1.min.js"></script>-->
    <script src="static/jquery-1.11.1.min.js"></script>
    <script src="static/jquery.cookie.js"></script>
    <script src="static/fastclick.js"></script>
    <link href="./xiami.css" rel="stylesheet">
    <style>
        html ,
        body {
            height: 100%;
            margin: 0;
            webkit-text-size-adjust: 100%;
        }
        html {
            overflow: hidden;
        }
        body {
            position: absolute;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding-top: 220px;
            transition: left .3s ease, -webkit-transform .3s ease;
            transition: transform .3s ease;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: subpixel-antialiased;
        }
        *, *:before, *:after {
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
        }
        a ,
        a:hover ,
        a:focus {
            text-decoration:none;
        }
        .play:after {
            content: '播放';
        }
        .play.pause:after {
            content: '暂停';
        }
        .progress_bar {
            position: fixed;
            cursor: ew-resize;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 15px;
            opacity: 0.8;
        }
        .adj .progress_bar {
            cursor: inherit;
        }
        #progress {
            background: #000;
            height: 15px;
            width: 0;
            z-index: 10;
            position: relative;

        }
        .buffer {
            position: absolute;
            top: 0;
            left: 0;
            background: #e8e8e8;
            height: 15px;
            width: 0;
        }
        .progress_bar .time {
            position: absolute;
            bottom: 24px;
            right: -27px;
            border: 1px solid #dedede;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            border-radius: 5px;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.89);
            filter:alpha(opacity=0);opacity:0;
            -webkit-transition: all .5s;
            -moz-transition: all .5s;
            transition: all .5s;
        }
        .progress_bar:hover .time {
            filter:alpha(opacity=100);opacity:1;
        }
        .progress_bar .time:after {
            content: '';
            position: absolute;
            bottom: -7px;
            left: 50%;
            margin-left: -7px;
            border: 7px dashed transparent;
            border-bottom: 0;
            border-top-width:7px;
            border-top-color: rgba(255, 255, 255, 0.90);
        }
        .progress_bar .time:before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            margin-left: -7px;
            border: 7px dashed transparent;
            border-bottom: 0;
            border-top-width:7px;
            border-top-color: rgba(227, 227, 227, 0.90);
        }
        .Cover {
            background-repeat: no-repeat;
            background-size: cover;
            background-position: 50% 50%;
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
            filter:alpha(opacity=20);opacity:0.2;
            -webkit-filter: blur(10px); /* Chrome, Opera */
            -moz-filter: blur(10px);
            -ms-filter: blur(10px);
            filter: blur(10px);
        }
        .name {
            font-size: 20px;
            display: inline-block;
            width: 100%;
            text-align: center;
            margin: 20px 0 5px;
        }
        .Cover-1 {
            padding: 5px;
            border: 2px solid #a2a2ae;
            width: 514px;
            height: 514px;
            -moz-border-radius: 50%;
            -webkit-border-radius: 50%;
            border-radius: 50%;
            background: #fff;
            position: absolute;
            top: -295px;
            left: 50%;
            margin-left: -257px;
            overflow: hidden;
        }
        .Cover-2 {
            width: 500px;
            height: 500px;
            background-position: 50% 50%;
            background-size: cover;
            background-repeat: no-repeat;
            background-color: #3D3D3D;
            -moz-border-radius: 50%;
            -webkit-border-radius: 50%;
            border-radius: 50%;
            animation:Cover-2 linear infinite 20s;
            -moz-animation:Cover-2 linear infinite 20s; /* Firefox */
            -webkit-animation:Cover-2 linear infinite 20s; /* Safari and Chrome */
            -o-animation:Cover-2 linear infinite 20s; /* Opera */
            position: relative;
        }
        @-webkit-keyframes Cover-2 /* Safari and Chrome */
        {
            0% {transform:rotate(0deg);
                -ms-transform:rotate(0deg); 	/* IE 9 */
                -moz-transform:rotate(0deg); 	/* Firefox */
                -webkit-transform:rotate(0deg); /* Safari 和 Chrome */
                -o-transform:rotate(0deg);}
            100% {transform:rotate(360deg);
                -ms-transform:rotate(360deg); 	/* IE 9 */
                -moz-transform:rotate(360deg); 	/* Firefox */
                -webkit-transform:rotate(360deg); /* Safari 和 Chrome */
                -o-transform:rotate(360deg);}
        }
        .Cover-1:before {
            content: '';
            width: 170px;
            height: 170px;
            background: url("./1.png") no-repeat;
            background-size: 170px;
            position: absolute;
            top: 50%;
            left: 50%;
            margin: -85px 0 0 -85px;
            -moz-border-radius: 50%;
            -webkit-border-radius: 50%;
            border-radius: 50%;
            -moz-box-shadow:2px 5px 5px rgba(0,0,0,.2) inset;
            -webkit-box-shadow:2px 5px 5px rgba(0,0,0,.2) inset;
            box-shadow:2px 5px 5px rgba(0,0,0,.2) inset;
            z-index: 10;
            animation:Cover-2 linear infinite 20s;
            -moz-animation:Cover-2 linear infinite 20s; /* Firefox */
            -webkit-animation:Cover-2 linear infinite 20s; /* Safari and Chrome */
            -o-animation:Cover-2 linear infinite 20s; /* Opera */
        }
        .Volume-box {
            position: fixed;
            left: 0;
            top: 10px;
        }
        .Volume {
            float: left;
            background: url("./2.png") no-repeat 50% 50%;
            width: 50px;
            height: 30px;
            background-size: 30px auto;
            border: none;
            cursor: pointer;
        }
        .Volume ,
        .list-btn {
            filter:alpha(opacity=50);opacity:0.5;
        }
        .Volume:hover ,
        .list-btn:hover {
            filter:alpha(opacity=100);opacity:1;
        }
        .Volume.off {
            background-image: url("./3.png");
            background-size: 25px auto;
            background-position: 5px 2px;
        }
        .Volume:focus ,
        .list-btn:focus {
            outline: none;
        }
        #range {
            margin: 5px 0;
            -webkit-transition: all .5s;
            -moz-transition: all .5s;
            transition: all .5s;
            filter:alpha(opacity=0);opacity:0;
        }

        .Volume-box:hover #range {
            filter:alpha(opacity=100);opacity:1;
        }
        .artist ,
        .album_name {
            font-size: 14px;
            color: #909090;
            text-align: center;
            line-height: 18px;
        }
        @media (max-width: 768px){
            body {
                padding-top: 120px;
            }
            .Cover-1 {
                width: 276px;
                height: 276px;
                top: -165px;
                left: 50%;
                margin-left: -138px;
                border: 1px solid #a2a2ae;
                padding: 2px;
            }
            .Cover-2 {
                width: 270px;
                height: 270px;
            }
            .Cover-1:before {
                width: 100px;
                height: 100px;
                background-size: 100px;
                margin: -50px 0 0 -50px;
            }
            .Volume-box ,
            .list-btn {
                display: block;
            }
        }
        .list {
            background: #000;
            position: absolute;
            top: 0;
            left: 100%;
            bottom: 0;
            border-left: 1px solid #e8e8e8;
            width: 300px;
            overflow-y: auto;
            -moz-box-shadow:0 1px 4px rgba(0,0,0,.2);
            -webkit-box-shadow:0 1px 4px rgba(0,0,0,.2);
            box-shadow: 0 1px 4px rgba(0,0,0,.2);
            color: #fff;
        }
        .list h5 {
            font-size: 20px;
            margin: 10px 0;
            padding: 0 15px;
            text-align: right;
        }
        .list ul{
            padding: 0;
            margin: 0;
        }
        .list li {
            list-style: none;
            border-bottom: 1px solid #3a3a3a;
        }
        .list li a {
            display: inline-block;
            width: 100%;
            padding: 10px 15px;
            font-size: 12px;
            color: #FFF;
            overflow:hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            -o-text-overflow: ellipsis;
            -moz-binding: url('ellipsis.xml#ellipsis');
        }
        .list li:nth-child(2n+1) {
            background: #2a2a2a;
        }
        .list li:hover ,
        .list li:hover a{
            background: #f1f1f1;
            color: #000000;
        }
        .list-btn {
            position: fixed;
            right: 0;
            top: 0;
            background: transparent;
            border: none;
            cursor: pointer;
            width: 51px;
            height: 40px;
        }
        #btn-sR{transition:.3s ease;}


        .list{transition:opacity .3s ease;-webkit-overflow-scrolling:touch;}
    </style>
</head>
<body>
<div id="status">尚未链接服务器</div>
<audio id="xiami" src="" title="小镇播放器"></audio>
<button class="play" style="display: none"></button>

<div class="progress_bar" id="bar">
    <div id="progress" class="move"><div class="time on">0:00</div></div>
    <div class="buffer"></div>
</div>
<div class="Cover"></div>
<div class="name"></div>
<div class="artist">演唱者：<span></span></div>
<div class="album_name">专辑：<span></span></div>

<div class="Cover-1">
    <div class="Cover-2"></div>
</div>
<div class="Volume-box">
    <button class="Volume on"></button>
    <input id="range" type="range" min="0" max="100" value="50">
</div>
<a href="javascript:void(0)" class="list-btn" id="btn-sR">
    <svg>
        <rect x="6" y="9" rx="2" ry="2" width="28" height="4"></rect>
        <rect x="6" y="18" rx="2" ry="2" width="28" height="4"></rect>
        <rect x="6" y="27" rx="2" ry="2" width="28" height="4"></rect>
    </svg>
</a>
<div class="list">
    <h5>播放列表</h5>
    <ul>
        <li><a href="#1769817357">星色夜空 - 藤宫ゆき</a></li>
        <li><a href="#1771226908">SEE YOU - 松下優也</a></li>
        <li><a href="#1773945663">Season - 瀧川ありさ</a></li>
        <li><a href="#1769798310">物凄い狂っとるフランちゃんが物凄いうた - Halozy</a></li>
        <li><a href="#1769798310">物凄い狂っとるフランちゃんが物凄いうた - Halozy</a></li>
    </ul>
</div>
<!--<script src="./xiami.js"></script>-->
<script type="text/javascript">


    function wait_sync(){


    }


    $(document).ready(function(){

       // var wsServer = 'ws://127.0.0.1:8810';
		var wsServer = 'ws://123.59.65.195:8810';
        ws = new WebSocket(wsServer);


        ws.onopen = function (evt) {





            ws.send('{"act":"sync"}');

        };

        ws.onclose = function (evt) {
            $('#status').html('已断开与服务器的链接');
        };


        ws.onmessage = function (evt) {
            console.log(evt.data);
            var res = eval('('+evt.data+')');
            if(res.act == 'sync'){
                if(res.data == 'wait'){
                    //

                    console.log('等2秒再发送同步信息');
                    setTimeout(2000,function(){
                        ws.send('{"act":"sync"}');

                    });


                }else{
                    console.log('播放ID:'+res.data.playId);
                    console.log('播放偏移:'+res.data.playTime);
                    console.log('播放地址:'+res.data.url);
                    music(res.data,1);
                }
                console.log(res.data);
            }else if(res.act =='online'){
                console.log(res.data);
                $('#status').html("有"+res.data+"人与您共同聆听");
            }else{
                console.log(res.data);
            }
        };

        ws.onerror = function (e) {
            $('#status').html('已断开与服务器的链接');
            console.log("onerror");
        };

        //跨域（可跨所有域名）
        /*var _u = function (str) {
            for (var _a = parseInt(str),_n = str.substr(1),_c = Math.floor(_n.length / _a),_y = _n.length % _a,_s = new Array(),i = 0; i < _y; i++)_s[i] = _n.substr((_c + 1) * i, _c + 1);
            for (i = _y; i < _a; i++)_s[i] = _n.substr(_c * (i - _y) + (_c + 1) * _y, _c);
            for (i = 0, _c = _n = ''; i < _s[0].length; i++)for (j = 0; j < _s.length; j++)_c += _s[j].substr(i, 1);
            for (i = 0, _c = unescape(_c); i < _c.length; i++)_c.substr(i, 1) == '^' ? _n += '0' : _n += _c.substr(i, 1);
            return _n;
        };*/
        var xiami = document.getElementById("xiami");

		//播放结束后执行
		xiami.addEventListener('ended',function(){
			//获取下一首歌曲
			if($('body').is('.adj')){
				console.log('电台播放,已经播放结束.发送同步');
				ws.send('{"act":"sync"}');
			}else{
				console.log('自主播放,已经播放结束.开始执行下一首歌曲');
				next(0,2);
			}
		},false);

        function music(r,mod){
            //var j = {"act":"sync","data":{"playId":"1769821950","playTime":"262","url":"http://127.0.0.1/xiami/1.mp3","title":"Eternal Light","length":"261","cover":"http:\/\/img.xiami.net\/images\/album\/img24\/46824\/3686691384929141.jpg","artist":"Libera","album":"Peace"}};
            //var A = new Audio();
            //A.src = _u(r[0].mp3);
            console.log('music');
            console.log(r);
            $('#xiami').attr({'src': r.url,'title':r.title});
            //console.log(r);
            $('.name').text(r.title);
            $('.album_name span').text(r.title);
            $('.artist span').text(r.artist);

            $('.Cover').css('background-image','url('+r.cover+')');
            $('.Cover-2').css('background-image','url('+r.cover+')');
            if( mod == 1){
                if($('body').is('.adj')){
                    xiami.addEventListener('canplay',function(){
                        var musicTime = xiami.duration - r.playTime;
                        if(xiami.duration > musicTime ){
                            xiami.currentTime=musicTime;
                        }else{
                            console.log('已经播放结束.开始执行下一首歌曲');
                        }
                    },false);
                }
            }
            xiami.addEventListener('canplay',bufferBar,false);

			xiami.play();



			//调整播放时间
            if(!$('body').is('.adj')){
                $('.progress_bar').mousedown(function(){
                    $('#progress').attr('class','on');
                    $('.time').removeClass('on');
                    $(window).mousemove(function(e){
                        $('#progress.on').css('width' , e.pageX+'px');
                        var surplus = xiami.duration;
                        var xx = e.pageX;
                        var w = $(document).width();
                        var progressValue = surplus*(xx/w);
                        var surplusMin = parseInt(progressValue/60);
                        var surplusSecond = parseInt(progressValue%60);
                        if (surplusSecond < 10 ) {
                            surplusSecond = '0'+surplusSecond;
                        }
                        $('.time').text(surplusMin + ":" +surplusSecond);
                    }).mouseup(function(ev){
                        $('#progress').attr('class','move');
                        adjustPorgress(this,ev);
                        $(window).unbind('mousemove').unbind('mouseup');
                        $('.time').addClass('on');
                        xiami.play();
                    });
                    document.body.onselectstart = document.body.ondrag = function(){
                        return false;
                    }
                });
            }

            //创建进度条和剩余时间
            xiami.addEventListener('timeupdate',function(){
                if (!isNaN(xiami.duration)) {
                    //剩余时间
                    var surplus = xiami.currentTime;
                    var surplusMin = parseInt(surplus/60);
                    var surplusSecond = parseInt(surplus%60);
                    if (surplusSecond < 10 ) {
                        surplusSecond = '0'+surplusSecond;
                    };
                    $('.time.on').text(surplusMin + ":" +surplusSecond);

                    //播放进度条//currentTime当前播放//duration总秒数
                    var progressValue = xiami.currentTime/xiami.duration*100;
                    $('#progress.move').css('width' , progressValue + '%');
                };
            },false);
            //开始执行的内容
            function bufferBar(){
                //===============================================显示缓冲进度条
                bufferTimer = setInterval(function(){
                    var bufferIndex = xiami.buffered.length;
                    if (bufferIndex > 0 && xiami.buffered != undefined) {
                        var bufferValue = xiami.buffered.end(bufferIndex-1)/xiami.duration*100;
                        $('.buffer').css('width' , bufferValue+'%');

                        if (Math.abs(xiami.duration - xiami.buffered.end(bufferIndex-1)) <1) {
                            $('.buffer').css('width' , 100+'%');
                            clearInterval(bufferTimer);
                        }
                    }
                },1000);
            }

            function adjustPorgress(dom,ev){
                var event = window.event || ev;
                var progressX = event.clientX/$(dom).width()*100;
                xiami.currentTime = parseInt(xiami.duration/100*progressX);
                xiami.removeEventListener('canplay',bufferBar,false);
            }


        }
        if(location.hash.substring(1) == '') {
            var musicId = 1774150235,
                    connect_server = 1;//检测是否连接上服务端
            if (connect_server == 1){
                $('body').addClass('adj');
                next();
                console.log('没有找到播放ID.开始同步播放');
            }else {
                console.log('与服务器中断链接,请刷新重试');
            }
        }else{
            $('body').removeClass('adj');
            next(location.hash.substring(1),1);
            console.log('获取到id,点播模式');
        }


        //下一曲
        function next(id,Mode){
            //  var j = {"act":"sync","data":{"playId":"1769821950","playTime":"262","url":"http://127.0.0.1/xiami/1.mp3","title":"Eternal Light","length":"261","cover":"http:\/\/img.xiami.net\/images\/album\/img24\/46824\/3686691384929141.jpg","artist":"Libera","album":"Peace"}};

            // music(j);
            /*var mod = 0;
             if(Mode == 1){
             var mod = 'song&id';
             console.log('获取#标签歌曲');
             }else if(Mode == 2) {
             var mod = 'radio&rid';
             console.log('获取随机歌曲');
             }
             $.get('http://itorr.sinaapp.com/fm/x/?a='+mod+'='+id+'&_r=' + Math.random(), function (r) {
             if(Mode == 1){
             music(r);
             console.log(r);
             }else if(Mode == 2) {
             location.href ='#'+r[1].xid;
             console.log(r);
             }
             });*/
        }
        /*//播放结束后执行
        xiami.addEventListener('ended',function(){
            //$('.play').removeClass('pause');
            //获取下一首歌曲
            if($('body').is('.adj')){
                setInterval (function(){
                    console.log('电台播放,已经播放结束.开始执行下一首歌曲');
                }, 1000);
            }else{
                console.log('自主播放,已经播放结束.开始执行下一首歌曲');
                next(0,2);
            }
        },false);*/
        //显示进度时间
        /*        $(".progress_bar").hover(function(){
         $(this).mousemove(function(e) {
         var surplus = xiami.duration;
         var xx = e.pageX;
         var w = $(document).width();
         var progressValue = surplus*(xx/w);
         var surplusMin = parseInt(progressValue/60);
         var surplusSecond = parseInt(progressValue%60);
         console.log(surplusMin+':'+surplusSecond);
         });
         },function(){
         });*/
        //右侧列表
        $('.list-btn').click(function(){
            var t = $("body");
            if (t.attr('style') == null) {
                t.css({'-webkit-transform': 'translateX(-300px)','transform': 'translateX(-300px)'});
            }else {
                t.removeAttr('style');
            }
        });
        /*
         //此方法已经过时
         $('.list a').click(function(){
         $.get('http://itorr.sinaapp.com/fm/x/?a=song&id=' + $(this).attr('href').substring(1) + '&_r=' + Math.random(), function (r) {
         music(r);
         });
         });*/

        (function() {
            if ('onhashchange' in window) {
                //if browser support onhaschange  如果浏览器支持onhaschange事件
                if (window.addEventListener) {
                    window.addHashChange = function(func, before) {
                        window.addEventListener('hashchange', func, before);
                    };
                    window.removeHashChange = function(func) {
                        window.removeEventListener('hashchange', func);
                    };
                    return;
                } else if (window.attachEvent) {
                    window.addHashChange = function(func) {
                        window.attachEvent('onhashchange', func);
                    };
                    window.removeHashChange = function(func) {
                        window.detachEvent('onhashchange', func);
                    };
                    return;
                }
            }
            //if the browser not support onhaschange 如果不支持的话
            var hashChangeFuncs = [];
            var oldHref = location.href;
            window.addHashChange = function(func, before) {
                if ( typeof func === 'function')
                    hashChangeFuncs[before ? 'unshift': 'push' ](func);
            };
            window.removeHashChange = function(func) {
                for (var i = hashChangeFuncs.length - 1; i >= 0; i--)
                    if (hashChangeFuncs[i] === func)
                        hashChangeFuncs.splice(i, 1);
            };
            //!!inportant!! 用setInterval检测has的改变
            setInterval(function() {
                var newHref = location.href;
                if (oldHref !== newHref) {
                    oldHref = newHref;
                    for (var i = 0; i < hashChangeFuncs.length; i++) {
                        hashChangeFuncs[i].call(window, {
                            'type' : 'hashchange',
                            'newURL' : newHref,
                            'oldURL' : oldHref
                        });
                    }
                }
            }, 100);
        })();
        // Usage, infinitely many times: 使用方法
        addHashChange(function(e) {
            $.get('http://itorr.sinaapp.com/fm/x/?a=song&id=' + location.hash.substring(1) + '&_r=' + Math.random(), function (r) {
                music(r);
            });
        });
        //播放按钮
        $('.play').click(function(){
            $(this).toggleClass('pause');
            if (!$(this).hasClass("pause")) {
                xiami.pause();
            }else {
                xiami.play();
            }
        });
        //音量调节
        $('#range').change(function(){
            if(!$('.Volume').is('.off')){
                var a = xiami.volume=$(this).val()/100;
                console.log(xiami.volume=$(this).val()/100);
                $.cookie('the_range', a);
            }
        });
        $('.Volume').click(function(){
            if(!$('.Volume').is('.off')){
                xiami.volume=0;
                $(this).removeClass('on').addClass('off');
            }else{
                $(this).removeClass('off').addClass('on');
                xiami.volume=$('#range').val()/100;
            }
        });
        $(".Volume.on").click(function(){
            console.log('321');
        });
        $(".Volume.off").click(function(){
            console.log('123');
        });
        if($.cookie('the_range') != null){
            var a = $.cookie('the_range');
            xiami.volume=a;
            $('#range').val(a*100);
        }else{
            xiami.volume=0.5;
        }


    });
    FastClick.attach(document.body);
</script>
</body>
</html>